<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <title>Mücahit Onur Diril - Resmi Randevu Başvuru Portalı</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <!-- Bootstrap Icons (form ikonları için) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    rel="stylesheet"
  >
  <style>
    body { background-color: #f5f5f5; }

    .admin-panel { display: none; }

    /* Navbar ve hero renkleri */
    .navbar-custom {
      background-color: #020617; /* çok koyu, soft lacivert */
    }

    .hero-section {
      background: linear-gradient(135deg, #020617, #0f172a);
      color: #fff;
      padding: 3rem 1rem;
      text-align: center;
    }

    .hero-avatar {
      width: 160px;
      height: 160px;
      object-fit: cover;
      border-radius: 50%;
      border: 4px solid rgba(255,255,255,0.9);
      box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.35);
      margin-bottom: 1.5rem;
      background-color: #fff;
    }

    .hero-title {
      font-size: 1.3rem;
      font-weight: 600;
      max-width: 720px;
      margin: 0 auto 1.5rem auto;
    }

    .hero-sub {
      font-size: 0.95rem;
      opacity: 0.9;
      max-width: 620px;
      margin: 0 auto 2rem auto;
    }

    /* Saat kutuları */
    .slot-btn {
      min-width: 96px;
      min-height: 56px;
      margin-bottom: 0.3rem;
      font-size: 0.85rem;
      line-height: 1.1;
      white-space: normal;
      padding: 0.35rem 0.5rem;
    }
    .slot-free {
      background-color: #e9ecef;
      color: #212529;
      border-color: #ced4da;
    }
    .slot-busy {
      background-color: #198754;
      border-color: #198754;
      color: #fff;
    }
    .slot-selected {
      box-shadow: 0 0 0 0.15rem rgba(13,110,253,.6);
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark navbar-custom mb-0">
  <div class="container">
    <a class="navbar-brand" href="#">Mücahit Onur Diril</a>
    <button class="btn btn-sm btn-outline-light ms-auto" id="adminToggleBtn">
      Admin Girişi
    </button>
  </div>
</nav>

<!-- AÇILIŞ SAYFASI / HERO -->
<section class="hero-section">
  <!-- Buradaki src, repo'ya yüklediğin fotoğrafın adı olmalı -->
  <img src="IMG_20251123_190305.jpg" alt="Mücahit Onur Diril"
       class="hero-avatar">

  <h1 class="hero-title">
    KRONİK GÜNDEM YOĞUNLUĞUNA KALICI ÇÖZÜM:<br>
    Mücahit Onur Diril Resmi Randevu Başvuru Portalı
  </h1>

  <p class="hero-sub">
    Yoğun gündem, sınırlı zaman, çok sayıda buluşma talebi…  
    Tüm programı düzenli ve adil bir şekilde yönetmek için randevu sistemine geçildi.
  </p>

  <div class="d-flex justify-content-center">
    <a href="#randevu-formu" class="btn btn-light btn-lg px-4">
      Randevu Al
    </a>
  </div>
</section>

<div class="container mb-5 mt-4">

  <!-- Kullanıcı formu -->
  <section id="randevu-formu" class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h2 class="h4 mb-3 text-center">Randevu Talep Formu</h2>
          <p class="text-muted small text-center mb-4">
            Randevu talebin onaya tabidir. Uygunluk durumuna göre sana dönüş yapılacaktır.
          </p>

          <div id="formAlert"></div>

          <form id="appointmentForm">
            <div class="mb-3">
              <label class="form-label">
                <i class="bi bi-person-circle me-1"></i>Ad Soyad *
              </label>
              <input type="text" name="name" class="form-control" required>
            </div>

            <div class="mb-3">
              <label class="form-label">
                <i class="bi bi-telephone-forward me-1"></i>İletişim Bilgisi (Telefon / E-posta)
              </label>
              <input type="text" name="contact" class="form-control" placeholder="Opsiyonel">
            </div>

            <!-- Gün & saat seçim takvimi -->
            <div class="mb-3">
              <label class="form-label">
                <i class="bi bi-calendar-week me-1"></i>Gün ve Saat Seçimi *
              </label>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="prevDayBtn">&lt;</button>
                <div id="dayLabel" class="fw-semibold"></div>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="nextDayBtn">&gt;</button>
              </div>
              <div id="slotsContainer" class="d-flex flex-wrap gap-2"></div>
              <!-- Eski hidden inputlar, geriye dönük uyumluluk için bırakıldı -->
              <input type="hidden" name="date" id="selectedDateInput">
              <input type="hidden" name="start_time" id="selectedStartInput">
              <input type="hidden" name="end_time" id="selectedEndInput">
              <div class="form-text">
                Hafta içi 17:00–01:00, hafta sonu 09:00–01:00 arası randevu alınabilir.
                <br>Boş saatler gri, onaylanmış randevular yeşildir. Seçmek için gri saat kutularına dokunabilirsiniz (çoklu seçim yapılabilir).
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">
                <i class="bi bi-chat-left-dots me-1"></i>Nedeni *
              </label>
              <select name="reason" class="form-select" required>
                <option value="">Seçiniz...</option>
                <option>ÇAY</option>
                <option>TENİS</option>
                <option>YEMEK</option>
                <option>GEZME</option>
                <option>PİKNİK</option>
                <option>TATLI</option>
                <option>İŞ / WORK</option>
                <option>DİĞER</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">
                <i class="bi bi-pencil-square me-1"></i>Not (Opsiyonel)
              </label>
              <textarea name="note" class="form-control" rows="3"
                        placeholder="Örn: Nerede buluşalım, ekstra notlar..."></textarea>
            </div>

            <div class="d-grid">
              <button type="submit" class="btn btn-primary">Randevu Talebini Gönder</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Admin Paneli -->
  <div class="admin-panel" id="adminPanel">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h5 mb-0">Admin Paneli</h2>
          <button class="btn btn-sm btn-outline-secondary" id="adminLogoutBtn">Çıkış</button>
        </div>

        <div class="mb-3">
          <span class="me-2">Filtre:</span>
          <button class="btn btn-sm btn-outline-primary me-1 status-filter" data-status="pending">Bekleyenler</button>
          <button class="btn btn-sm btn-outline-success me-1 status-filter" data-status="approved">Onaylananlar</button>
          <button class="btn btn-sm btn-outline-danger me-1 status-filter" data-status="rejected">Reddedilenler</button>
          <button class="btn btn-sm btn-outline-secondary status-filter" data-status="all">Tümü</button>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead>
            <tr>
              <th>#</th>
              <th>Tarih</th>
              <th>Saat</th>
              <th>Ad Soyad</th>
              <th>İletişim</th>
              <th>Neden</th>
              <th>Not</th>
              <th>Durum</th>
              <th>İşlem</th>
            </tr>
            </thead>
            <tbody id="appointmentsTableBody">
            <!-- JS ile doldurulacak -->
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Basit "veritabanı": localStorage
  const STORAGE_KEY = "randevu_kayitlari_v1";
  const ADMIN_PASSWORD = "242935"; // Yeni admin şifresi

  function loadAppointments() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];
    try {
      return JSON.parse(raw);
    } catch (e) {
      console.error("JSON parse hatası", e);
      return [];
    }
  }

  function saveAppointments(list) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
  }

  function addAppointment(data) {
    const list = loadAppointments();
    const id = list.length ? (list[list.length - 1].id + 1) : 1;
    const now = new Date().toISOString();
    list.push({
      id,
      ...data,
      status: "pending",
      created_at: now
    });
    saveAppointments(list);
    return id;
  }

  function updateAppointmentStatus(id, newStatus) {
    const list = loadAppointments();
    const idx = list.findIndex(item => item.id === id);
    if (idx !== -1) {
      list[idx].status = newStatus;
      saveAppointments(list);
    }
  }

  // Sadece ONAYLANMIŞ randevular haritaya girsin ve tür bilgisini tutsun
  function getOccupiedMap() {
    const list = loadAppointments();
    const map = {};
    for (const a of list) {
      if (a.status !== "approved") continue; // sadece approved
      if (!a.date || !a.start_time) continue;
      const key = a.date + "T" + a.start_time;
      map[key] = a.reason || "DOLU";
    }
    return map;
  }

  function showAlert(message, type="success") {
    const alertDiv = document.getElementById("formAlert");
    alertDiv.innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
  }

  // === Gün & saat takvimi ===
  const prevDayBtn = document.getElementById("prevDayBtn");
  const nextDayBtn = document.getElementById("nextDayBtn");
  const dayLabel = document.getElementById("dayLabel");
  const slotsContainer = document.getElementById("slotsContainer");
  const selectedDateInput = document.getElementById("selectedDateInput");

  let currentDate = new Date();
  currentDate.setHours(0,0,0,0);

  const dayNames = ["Pazar","Pazartesi","Salı","Çarşamba","Perşembe","Cuma","Cumartesi"];

  // Aynı gün içinde çoklu slot seçimi için
  let selectedSlots = new Set();

  function isWeekend(date) {
    const d = date.getDay();
    return d === 0 || d === 6; // Pazar veya Cumartesi
  }

  function formatHour(h) {
    const hh = h.toString().padStart(2, "0");
    return hh + ":00";
  }

  function nextHourStr(timeStr) {
    const [h, m] = timeStr.split(":").map(Number);
    let h2 = (h + 1) % 24;
    return h2.toString().padStart(2, "0") + ":00";
  }

  function getSlotsForDate(date) {
    const weekend = isWeekend(date);
    const times = [];
    const start = weekend ? 9 : 17; // Hafta sonu 09, hafta içi 17
    for (let h = start; h <= 23; h++) {
      times.push(formatHour(h));
    }
    // Gece 00:00 slotu (00:00-01:00)
    times.push("00:00");
    return times;
  }

  function renderDay() {
    const dateStr = currentDate.toISOString().slice(0,10);
    selectedDateInput.value = dateStr;

    const labelText = dayNames[currentDate.getDay()] + " - " +
      currentDate.toLocaleDateString("tr-TR");
    dayLabel.textContent = labelText;

    const occupiedMap = getOccupiedMap();
    const slots = getSlotsForDate(currentDate);

    slotsContainer.innerHTML = "";
    // Gün değişince seçimleri sıfırla
    selectedSlots = new Set();

    for (const time of slots) {
      const key = dateStr + "T" + time;
      const reasonText = occupiedMap[key];
      const isBusy = !!reasonText;

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "btn slot-btn";

      if (isBusy) {
        // Dolu slot: yeşil + tür
        btn.classList.add("slot-busy");
        btn.disabled = true;
        btn.innerHTML = `${time}<br><small>${reasonText}</small>`;
      } else {
        // Boş slot: gri ve çoklu seçime uygun
        btn.classList.add("slot-free");
        btn.textContent = time;

        btn.addEventListener("click", () => {
          if (selectedSlots.has(time)) {
            selectedSlots.delete(time);
            btn.classList.remove("slot-selected");
          } else {
            selectedSlots.add(time);
            btn.classList.add("slot-selected");
          }
        });
      }

      slotsContainer.appendChild(btn);
    }
  }

  prevDayBtn.addEventListener("click", () => {
    const today = new Date();
    today.setHours(0,0,0,0);
    const newDate = new Date(currentDate);
    newDate.setDate(currentDate.getDate() - 1);
    // geçmiş tarihlere izin verme
    if (newDate < today) return;
    currentDate = newDate;
    renderDay();
  });

  nextDayBtn.addEventListener("click", () => {
    const newDate = new Date(currentDate);
    newDate.setDate(currentDate.getDate() + 1);
    currentDate = newDate;
    renderDay();
  });

  // Form gönderimi
  const form = document.getElementById("appointmentForm");
  form.addEventListener("submit", function (e) {
    e.preventDefault();
    const formData = new FormData(form);

    const baseData = {
      name: formData.get("name").trim(),
      contact: formData.get("contact").trim(),
      date: selectedDateInput.value,
      reason: formData.get("reason"),
      note: formData.get("note").trim()
    };

    if (!baseData.name || !baseData.date || !baseData.reason) {
      showAlert("Lütfen ad, gün ve nedeni doldurun.", "danger");
      return;
    }

    if (selectedSlots.size === 0) {
      showAlert("Lütfen en az bir saat dilimi seçin.", "danger");
      return;
    }

    // Seçili her slot için ayrı randevu kaydı oluştur
    const times = Array.from(selectedSlots).sort();
    for (const time of times) {
      const data = {
        ...baseData,
        start_time: time,
        end_time: nextHourStr(time)
      };
      addAppointment(data);
    }

    form.reset();
    // Seçimler temizlensin
    selectedSlots = new Set();
    renderDay();
    showAlert("Randevu talebiniz alındı. Onaylanan saatler takvimde yeşil görünecektir.", "success");
  });

  // Admin paneli
  const adminToggleBtn = document.getElementById("adminToggleBtn");
  const adminPanel = document.getElementById("adminPanel");
  const adminLogoutBtn = document.getElementById("adminLogoutBtn");
  const appointmentsTableBody = document.getElementById("appointmentsTableBody");
  let currentFilter = "pending";

  function renderAppointments(filterStatus) {
    const list = loadAppointments();
    let filtered = list;
    if (filterStatus !== "all") {
      filtered = list.filter(item => item.status === filterStatus);
    }
    appointmentsTableBody.innerHTML = "";
    if (!filtered.length) {
      appointmentsTableBody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">Kayıt bulunamadı.</td></tr>`;
      return;
    }

    for (const a of filtered) {
      let badgeClass = "bg-warning text-dark";
      let badgeText = "Beklemede";
      if (a.status === "approved") {
        badgeClass = "bg-success";
        badgeText = "Onaylandı";
      } else if (a.status === "rejected") {
        badgeClass = "bg-danger";
        badgeText = "Reddedildi";
      }

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${a.id}</td>
        <td>${a.date}</td>
        <td>${a.start_time} - ${a.end_time}</td>
        <td>${a.name}</td>
        <td>${a.contact || ""}</td>
        <td>${a.reason}</td>
        <td style="max-width:250px;">${a.note || ""}</td>
        <td><span class="badge ${badgeClass}">${badgeText}</span></td>
        <td>
          <div class="d-flex gap-1">
            ${a.status !== "approved" ? `<button class="btn btn-sm btn-success approve-btn" data-id="${a.id}">Onayla</button>` : ""}
            ${a.status !== "rejected" ? `<button class="btn btn-sm btn-outline-danger reject-btn" data-id="${a.id}">Reddet</button>` : ""}
          </div>
        </td>
      `;
      appointmentsTableBody.appendChild(row);
    }

    document.querySelectorAll(".approve-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = parseInt(btn.getAttribute("data-id"));
        updateAppointmentStatus(id, "approved");
        renderAppointments(currentFilter);
        renderDay(); // takvimi de güncelle
      });
    });
    document.querySelectorAll(".reject-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = parseInt(btn.getAttribute("data-id"));
        updateAppointmentStatus(id, "rejected");
        renderAppointments(currentFilter);
        renderDay();
      });
    });
  }

  adminToggleBtn.addEventListener("click", () => {
    const pass = prompt("Admin şifresini giriniz:");
    if (pass === ADMIN_PASSWORD) {
      adminPanel.style.display = "block";
      currentFilter = "pending";
      renderAppointments(currentFilter);
    } else if (pass !== null) {
      alert("Hatalı şifre!");
    }
  });

  adminLogoutBtn.addEventListener("click", () => {
    adminPanel.style.display = "none";
  });

  document.querySelectorAll(".status-filter").forEach(btn => {
    btn.addEventListener("click", () => {
      currentFilter = btn.getAttribute("data-status");
      renderAppointments(currentFilter);
    });
  });

  // Sayfa yüklenince bugünden başla
  renderDay();
</script>

</body>
  </html>
