<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <title>Randevu Sistemi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <style>
    body { background-color: #f5f5f5; }
    .admin-panel { display: none; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container">
    <a class="navbar-brand" href="#">Randevu Sistemi</a>
    <button class="btn btn-sm btn-outline-light ms-auto" id="adminToggleBtn">
      Admin Girişi
    </button>
  </div>
</nav>

<div class="container mb-5">

  <!-- Kullanıcı formu -->
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h1 class="h4 mb-3 text-center">Randevu Talep Et</h1>
          <p class="text-muted small text-center mb-4">
            Randevu talebin onaya tabidir. Uygunluk durumuna göre sana dönüş yapılacaktır.
          </p>

          <div id="formAlert"></div>

          <form id="appointmentForm">
            <div class="mb-3">
              <label class="form-label">Ad Soyad *</label>
              <input type="text" name="name" class="form-control" required>
            </div>

            <div class="mb-3">
              <label class="form-label">İletişim Bilgisi (Telefon / E-posta)</label>
              <input type="text" name="contact" class="form-control" placeholder="Opsiyonel">
            </div>

            <div class="mb-3">
              <label class="form-label">Tarih *</label>
              <input type="date" name="date" class="form-control" required>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Başlangıç Saati *</label>
                <input type="time" name="start_time" class="form-control" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Bitiş Saati *</label>
                <input type="time" name="end_time" class="form-control" required>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Nedeni *</label>
              <select name="reason" class="form-select" required>
                <option value="">Seçiniz...</option>
                <option>ÇAY</option>
                <option>TENİS</option>
                <option>YEMEK</option>
                <option>GEZME</option>
                <option>PİKNİK</option>
                <option>TATLI</option>
                <option>DİĞER</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Not (Opsiyonel)</label>
              <textarea name="note" class="form-control" rows="3"
                        placeholder="Örn: Nerede buluşalım, ekstra notlar..."></textarea>
            </div>

            <div class="d-grid">
              <button type="submit" class="btn btn-primary">Randevu Talebini Gönder</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Paneli -->
  <div class="admin-panel" id="adminPanel">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h5 mb-0">Admin Paneli</h2>
          <button class="btn btn-sm btn-outline-secondary" id="adminLogoutBtn">Çıkış</button>
        </div>

        <div class="mb-3">
          <span class="me-2">Filtre:</span>
          <button class="btn btn-sm btn-outline-primary me-1 status-filter" data-status="pending">Bekleyenler</button>
          <button class="btn btn-sm btn-outline-success me-1 status-filter" data-status="approved">Onaylananlar</button>
          <button class="btn btn-sm btn-outline-danger me-1 status-filter" data-status="rejected">Reddedilenler</button>
          <button class="btn btn-sm btn-outline-secondary status-filter" data-status="all">Tümü</button>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead>
            <tr>
              <th>#</th>
              <th>Tarih</th>
              <th>Saat</th>
              <th>Ad Soyad</th>
              <th>İletişim</th>
              <th>Neden</th>
              <th>Not</th>
              <th>Durum</th>
              <th>İşlem</th>
            </tr>
            </thead>
            <tbody id="appointmentsTableBody">
            <!-- JS ile doldurulacak -->
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Basit "veritabanı": localStorage
  const STORAGE_KEY = "randevu_kayitlari_v1";
  const ADMIN_PASSWORD = "1234"; // Bunu kendine göre değiştir

  function loadAppointments() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];
    try {
      return JSON.parse(raw);
    } catch (e) {
      console.error("JSON parse hatası", e);
      return [];
    }
  }

  function saveAppointments(list) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
  }

  function addAppointment(data) {
    const list = loadAppointments();
    const id = list.length ? (list[list.length - 1].id + 1) : 1;
    const now = new Date().toISOString();
    list.push({
      id,
      ...data,
      status: "pending",
      created_at: now
    });
    saveAppointments(list);
    return id;
  }

  function updateAppointmentStatus(id, newStatus) {
    const list = loadAppointments();
    const idx = list.findIndex(item => item.id === id);
    if (idx !== -1) {
      list[idx].status = newStatus;
      saveAppointments(list);
    }
  }

  function showAlert(message, type="success") {
    const alertDiv = document.getElementById("formAlert");
    alertDiv.innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
  }

  // Form gönderimi
  const form = document.getElementById("appointmentForm");
  form.addEventListener("submit", function (e) {
    e.preventDefault();
    const formData = new FormData(form);

    const data = {
      name: formData.get("name").trim(),
      contact: formData.get("contact").trim(),
      date: formData.get("date"),
      start_time: formData.get("start_time"),
      end_time: formData.get("end_time"),
      reason: formData.get("reason"),
      note: formData.get("note").trim()
    };

    if (!data.name || !data.date || !data.start_time || !data.end_time || !data.reason) {
      showAlert("Lütfen zorunlu alanları doldurun.", "danger");
      return;
    }

    addAppointment(data);
    form.reset();
    showAlert("Randevu talebiniz alındı. Onaylandığında size haber verilecektir.", "success");
  });

  // Admin paneli
  const adminToggleBtn = document.getElementById("adminToggleBtn");
  const adminPanel = document.getElementById("adminPanel");
  const adminLogoutBtn = document.getElementById("adminLogoutBtn");
  const appointmentsTableBody = document.getElementById("appointmentsTableBody");
  let currentFilter = "pending";

  function renderAppointments(filterStatus) {
    const list = loadAppointments();
    let filtered = list;
    if (filterStatus !== "all") {
      filtered = list.filter(item => item.status === filterStatus);
    }
    appointmentsTableBody.innerHTML = "";
    if (!filtered.length) {
      appointmentsTableBody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">Kayıt bulunamadı.</td></tr>`;
      return;
    }

    for (const a of filtered) {
      let badgeClass = "bg-warning text-dark";
      let badgeText = "Beklemede";
      if (a.status === "approved") {
        badgeClass = "bg-success";
        badgeText = "Onaylandı";
      } else if (a.status === "rejected") {
        badgeClass = "bg-danger";
        badgeText = "Reddedildi";
      }

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${a.id}</td>
        <td>${a.date}</td>
        <td>${a.start_time} - ${a.end_time}</td>
        <td>${a.name}</td>
        <td>${a.contact || ""}</td>
        <td>${a.reason}</td>
        <td style="max-width:250px;">${a.note || ""}</td>
        <td><span class="badge ${badgeClass}">${badgeText}</span></td>
        <td>
          <div class="d-flex gap-1">
            ${a.status !== "approved" ? `<button class="btn btn-sm btn-success approve-btn" data-id="${a.id}">Onayla</button>` : ""}
            ${a.status !== "rejected" ? `<button class="btn btn-sm btn-outline-danger reject-btn" data-id="${a.id}">Reddet</button>` : ""}
          </div>
        </td>
      `;
      appointmentsTableBody.appendChild(row);
    }

    document.querySelectorAll(".approve-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = parseInt(btn.getAttribute("data-id"));
        updateAppointmentStatus(id, "approved");
        renderAppointments(currentFilter);
      });
    });
    document.querySelectorAll(".reject-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = parseInt(btn.getAttribute("data-id"));
        updateAppointmentStatus(id, "rejected");
        renderAppointments(currentFilter);
      });
    });
  }

  adminToggleBtn.addEventListener("click", () => {
    const pass = prompt("Admin şifresini giriniz:");
    if (pass === ADMIN_PASSWORD) {
      adminPanel.style.display = "block";
      currentFilter = "pending";
      renderAppointments(currentFilter);
    } else if (pass !== null) {
      alert("Hatalı şifre!");
    }
  });

  adminLogoutBtn.addEventListener("click", () => {
    adminPanel.style.display = "none";
  });

  document.querySelectorAll(".status-filter").forEach(btn => {
    btn.addEventListener("click", () => {
      currentFilter = btn.getAttribute("data-status");
      renderAppointments(currentFilter);
    });
  });
</script>

</body>
  </html>
